<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Memeflix - Staff (Acceso)</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    /* Ajustes locales */
    .staff-shell { padding: calc(var(--nav-height) + 20px) 16px 60px; min-height:100vh; display:flex;flex-direction:column;gap:18px; align-items:center; }
    .card.staff-card { width:100%; max-width:720px; padding:20px; border-radius:12px; background:var(--glass-bg); border:1px solid var(--glass-border); box-shadow:0 10px 30px rgba(0,0,0,0.6); }
    .hint { color:var(--muted); margin-top:8px }
    .controls { display:flex;gap:8px;flex-wrap:wrap }
    .danger { color:#ff6b6b }
    .small { font-size:0.9rem; color:var(--muted) }
    .option { display:block; padding:12px; border-radius:10px; background:#111; color:var(--text); text-decoration:none; border:1px solid rgba(255,255,255,0.03); margin-bottom:8px }
    .option:hover { transform:translateY(-4px); box-shadow:0 8px 30px rgba(0,255,0,0.06) }
  </style>
</head>
<body>
  <canvas id="matrix" aria-hidden="true"></canvas>

  <header class="navbar page-layer" role="banner">
    <div class="logo">MEMEFLIX</div>
    <button class="menu-toggle" aria-label="Abrir menú" aria-expanded="false">☰</button>
    <nav aria-label="Menú principal">
      <ul class="nav-links" role="menubar">
        <li role="none"><a role="menuitem" href="../home.html">Inicio</a></li>
        <li role="none"><a role="menuitem" href="../memes.html">Memes</a></li>
        <li role="none"><a role="menuitem" href="../sugerencias.html">Sugerencias</a></li>
        <li role="none"><a role="menuitem" href="../minijuegos.html">Minijuegos</a></li>
      </ul>
    </nav>
    <div class="nav-right page-layer">
      <div class="usuario" aria-live="polite"></div>
      <a class="btn ghost" href="estadisticas.html">Estadísticas</a>
    </div>
  </header>

  <main class="page-layer staff-shell">
    <div class="container">
      <div class="card staff-card" id="cardRoot">
        <h2 id="cardTitle" style="margin:0 0 8px;color:var(--accent-red)">Acceso Staff</h2>

        <p id="intro" class="hint">Acceso restringido. Introduce la contraseña para acceder al panel Staff.</p>

        <!-- Formulario de login (único) -->
        <form id="loginForm" style="display:none" autocomplete="current-password">
          <label class="small">Contraseña</label>
          <input id="loginPass" type="password" placeholder="Contraseña" required>
          <div class="controls" style="margin-top:8px">
            <button class="btn" type="submit">Entrar</button>
            <button id="cancelBtn" type="button" class="btn ghost">Volver</button>
          </div>
          <div id="loginMsg" class="hint"></div>
        </form>

        <!-- Panel tras login -->
        <div id="panelArea" style="display:none;margin-top:12px">
          <div class="hint">Bienvenido al panel Staff. Usa las opciones para revisar estadísticas y sugerencias.</div>
          <div style="margin-top:12px;display:grid;gap:12px">
            <a class="option" href="estadisticas.html">Ver Estadísticas</a>
            <a class="option" href="sugerenciasresultados.html">Ver Sugerencias</a>
            <a class="option" href="../minijuegos.html">Gestionar Minijuegos</a>
            <a class="option" href="../memes.html">Gestionar Memes</a>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="logoutBtn" class="btn small danger">Cerrar sesión</button>
            </div>
          </div>
        </div>

      </div>

      <div style="margin-top:12px;text-align:center" class="small">
        <p>Nota: la contraseña es obligatoria y está fijada por el sistema. Esta implementación es cliente‑side y no sustituye un backend seguro.</p>
      </div>
    </div>
  </main>

  <script src="../js/matrix.js"></script>
  <script src="../js/main.js"></script>

  <script>
  // STAFF access con contraseña fija (cliente-side)
  (function(){
    // Configuración
    const FIXED_PASSWORD = 'kneeguard'; // contraseña fija solicitada
    const SESSION_KEY = 'staffAuth';     // sessionStorage flag con expiry
    const MAX_ATTEMPTS = 5;
    const SESSION_MINUTES = 30;
    const ATTEMPTS_KEY = 'staffAttempts';
    const LOCK_KEY = 'staffLockUntil';

    // DOM
    const loginForm = document.getElementById('loginForm');
    const loginPass = document.getElementById('loginPass');
    const loginMsg = document.getElementById('loginMsg');
    const cancelBtn = document.getElementById('cancelBtn');
    const panelArea = document.getElementById('panelArea');
    const logoutBtn = document.getElementById('logoutBtn');

    // Session helpers
    function setSession(){
      const expiry = Date.now() + SESSION_MINUTES * 60 * 1000;
      sessionStorage.setItem(SESSION_KEY, String(expiry));
    }
    function clearSession(){
      sessionStorage.removeItem(SESSION_KEY);
    }
    function isSessionValid(){
      const v = sessionStorage.getItem(SESSION_KEY);
      if(!v) return false;
      return Date.now() < parseInt(v,10);
    }

    // Attempts helpers
    function incAttempts(){
      const v = parseInt(localStorage.getItem(ATTEMPTS_KEY) || '0', 10) + 1;
      localStorage.setItem(ATTEMPTS_KEY, String(v));
      return v;
    }
    function resetAttempts(){ localStorage.removeItem(ATTEMPTS_KEY); }

    // Lock helpers
    function setLock(minutes){
      const until = Date.now() + minutes * 60 * 1000;
      localStorage.setItem(LOCK_KEY, String(until));
    }
    function getLock(){
      return parseInt(localStorage.getItem(LOCK_KEY) || '0', 10);
    }
    function clearLock(){ localStorage.removeItem(LOCK_KEY); }

    // UI helpers
    function showLogin(){ loginForm.style.display = ''; panelArea.style.display = 'none'; loginMsg.textContent = ''; }
    function showPanel(){ loginForm.style.display = 'none'; panelArea.style.display = ''; loginMsg.textContent = ''; }

    // Inicialización
    function initUI(){
      // mostrar usuario en header
      const usuario = localStorage.getItem('usuarioMemeflix');
      document.querySelectorAll('.usuario').forEach(el => el.textContent = usuario ? ` _ ${usuario}` : 'Invitado');

      // si sesión válida, mostrar panel
      if(isSessionValid()){
        showPanel();
        return;
      }

      // comprobar bloqueo temporal
      const lockUntil = getLock();
      if(lockUntil && Date.now() < lockUntil){
        const remaining = Math.ceil((lockUntil - Date.now()) / 1000);
        showLogin();
        loginMsg.textContent = `Bloqueado temporalmente. Intenta de nuevo en ${remaining} s.`;
        loginForm.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => {
          loginForm.querySelector('button[type="submit"]').disabled = false;
          clearLock();
          resetAttempts();
          loginMsg.textContent = '';
        }, lockUntil - Date.now());
        return;
      }

      showLogin();
    }

    // Login submit
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      loginMsg.textContent = '';
      const p = loginPass.value || '';
      if(p === FIXED_PASSWORD){
        resetAttempts();
        clearLock();
        setSession();
        loginPass.value = '';
        showPanel();
      } else {
        const attempts = incAttempts();
        const left = Math.max(0, MAX_ATTEMPTS - attempts);
        loginMsg.textContent = `Contraseña incorrecta. Intentos restantes: ${left}.`;
        if(attempts >= MAX_ATTEMPTS){
          loginMsg.textContent = 'Demasiados intentos. Bloqueo temporal activado (5 minutos).';
          setLock(5); // 5 minutos
          loginForm.querySelector('button[type="submit"]').disabled = true;
          setTimeout(() => {
            loginForm.querySelector('button[type="submit"]').disabled = false;
            resetAttempts();
            clearLock();
            loginMsg.textContent = '';
          }, 5 * 60 * 1000);
        }
      }
    });

    // Cancel / volver
    cancelBtn.addEventListener('click', () => {
      window.location.href = '../home.html';
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      clearSession();
      showLogin();
    });

    // Inicializar UI al cargar
    initUI();

    // Mantener sesión válida si se abre en otra pestaña
    window.addEventListener('storage', (e) => {
      if(e.key === SESSION_KEY){
        if(isSessionValid()) showPanel(); else showLogin();
      }
    });

  })();
  </script>
</body>
</html>

