<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Memeflix - Estadísticas</title>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="estadisticas.css">
</head>
<body>
  <!-- Fondo Matrix -->
  <canvas id="matrix"></canvas>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">MEMEFLIX</div>
    <ul class="nav-links">
      <li><a href="../home.html">Inicio</a></li>
      <li><a href="../memes.html">Memes</a></li>
      <li><a href="../sugerencias.html">Sugerencias</a></li>
      <li><a href="../minijuegos.html">Minijuegos</a></li>
      <li><a href="staff.html">Staff</a></li>
      <li><a href="estadisticas.html" class="active">Estadísticas</a></li>
    </ul>
    <div class="usuario" id="usuarioDisplay"></div>
  </nav>

  <header class="stats-header glass">
    <h1>Estadísticas en tiempo real</h1>
    <p>Panel técnico de Memeflix</p>
  </header>

  <main class="stats-main">
    <!-- Tarjetas de métricas -->
    <section class="stats-grid">
      <div class="stat-card glass">
        <h2>Usuarios activos</h2>
        <p class="stat-number" data-key="usuariosActivos">0</p>
        <p class="stat-desc">Últimas 24h</p>
      </div>

      <div class="stat-card glass">
        <h2>Visitas</h2>
        <p class="stat-number" data-key="visitas">0</p>
        <p class="stat-desc">Sesiones en esta web</p>
      </div>

      <div class="stat-card glass">
        <h2>Memes vistos</h2>
        <p class="stat-number" data-key="memesVistos">0</p>
        <p class="stat-desc">Impresiones de tarjetas</p>
      </div>

      <div class="stat-card glass">
        <h2>Minijuegos jugados</h2>
        <p class="stat-number" data-key="minijuegosJugados">0</p>
        <p class="stat-desc">Partidas totales</p>
      </div>

      <div class="stat-card glass">
        <h2>Sugerencias enviadas</h2>
        <p class="stat-number" data-key="sugerenciasEnviadas">0</p>
        <p class="stat-desc">Entradas en el buzón</p>
      </div>

      <div class="stat-card glass">
        <h2>Tiempo en sitio</h2>
        <p class="stat-number" data-key="tiempoEnSitio">0</p>
        <p class="stat-desc">Minutos acumulados</p>
      </div>
    </section>

    <!-- Gráfica simple de actividad semanal -->
    <section class="charts glass">
      <h2>Actividad semanal</h2>
      <div class="chart-bar" id="chartSemanal">
        <!-- Se auto-renderiza con JS -->
      </div>
    </section>

    <!-- Ranking de usuarios (ejemplo dinámico) -->
    <section class="ranking glass">
      <h2>Top usuarios</h2>
      <ol id="topUsuarios">
        <!-- Se llena con JS usando localStorage -->
      </ol>
    </section>
  </main>

  <footer class="stats-footer glass">
    <p>Memeflix © 2025 • Panel de estadísticas</p>
  </footer>

  <script>
    // Mostrar el usuario logueado
    const usuarioLog = localStorage.getItem("usuarioMemeflix");
    document.getElementById("usuarioDisplay").textContent = usuarioLog ? usuarioLog : "Invitado";

    // ---------- Métricas automáticas ----------
    // Convención de claves en localStorage en toda la web:
    // - visitas: contador global de sesiones (incrementa en home.html con cada carga)
    // - memesVistos: incrementa al abrir/scroll en memes.html
    // - minijuegosJugados: incrementa al finalizar una partida en minijuegos.html / js/*
    // - sugerenciasEnviadas: incrementa al enviar el formulario de sugerencias
    // - tiempoEnSitio: minutos acumulados (sumar en home/minijuegos mediante timers)
    // - usuariosActivos: aproximación: tamaño del set de usuarios vistos en 24h (demo)
    // - actividadSemanal: array con 7 valores (lun-dom) para gráfico

    // Lectura segura de números
    function getNum(key, def = 0) {
      const v = localStorage.getItem(key);
      const n = parseInt(v, 10);
      return isNaN(n) ? def : n;
    }

    // Demo de usuarios activos: guardamos un "set" simple en localStorage
    // Añade usuarios a 'usuariosSet' cuando hagan login. Aquí sólo contamos.
    function contarUsuariosActivos() {
      const raw = localStorage.getItem("usuariosSet");
      if (!raw) return 1; // mínimo 1 para demo
      try {
        const set = JSON.parse(raw);
        return Array.isArray(set) ? set.length : 1;
      } catch {
        return 1;
      }
    }

    // Poblar valores destino
    const valores = {
      usuariosActivos: contarUsuariosActivos(),
      visitas: getNum("visitas"),
      memesVistos: getNum("memesVistos"),
      minijuegosJugados: getNum("minijuegosJugados"),
      sugerenciasEnviadas: getNum("sugerenciasEnviadas"),
      tiempoEnSitio: getNum("tiempoEnSitio")
    };

    // Animar contadores
    function animateCounter(el, target, duration = 800) {
      const start = 0;
      const startTime = performance.now();
      function tick(now) {
        const p = Math.min((now - startTime) / duration, 1);
        const val = Math.floor(start + (target - start) * p);
        el.textContent = val.toLocaleString("es-ES");
        if (p < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    document.querySelectorAll(".stat-number").forEach(el => {
      const key = el.getAttribute("data-key");
      const target = valores[key] ?? 0;
      animateCounter(el, target);
    });

    // ---------- Gráfico semanal ----------
    // Guardar en toda la web un array JSON: actividadSemanal = [80,60,90,50,70,40,30]
    function getSemanal() {
      const raw = localStorage.getItem("actividadSemanal");
      if (!raw) return [80, 60, 90, 50, 70, 40, 30]; // demo
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) && arr.length === 7 ? arr : [80,60,90,50,70,40,30];
      } catch {
        return [80,60,90,50,70,40,30];
      }
    }

    const dias = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
    const data = getSemanal();
    const chart = document.getElementById("chartSemanal");

    data.forEach((val, i) => {
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.setProperty("--altura", Math.max(10, Math.min(100, val)) + "%");
      bar.innerHTML = `<span>${dias[i]}</span>`;
      chart.appendChild(bar);
      // animación inicio
      requestAnimationFrame(() => bar.classList.add("on"));
    });

    // ---------- Top usuarios ----------
    // Estructura esperada en localStorage: topUsuarios = [{nombre:"Jaime", memes:320}, ...]
    function getTopUsuarios() {
      const raw = localStorage.getItem("topUsuarios");
      if (!raw) return [
        { nombre: "Jaime", memes: 320 },
        { nombre: "Laura", memes: 280 },
        { nombre: "Carlos", memes: 250 },
        { nombre: "Ana", memes: 200 }
      ];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) && arr.length ? arr : [];
      } catch {
        return [];
      }
    }

    const top = getTopUsuarios();
    const ol = document.getElementById("topUsuarios");
    if (top.length === 0) {
      ol.innerHTML = "<li>No hay datos suficientes</li>";
    } else {
      ol.innerHTML = top
        .sort((a, b) => (b.memes || 0) - (a.memes || 0))
        .map(u => `<li>${u.nombre} — ${u.memes} memes</li>`)
        .join("");
    }

    // ---------- Fondo Matrix ----------
    const canvas = document.getElementById("matrix");
    const ctx = canvas.getContext("2d");
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener("resize", resize);

    const letters = "アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const fontSize = 16;
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1);

    function draw() {
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#0f0";
      ctx.font = fontSize + "px monospace";

      for (let i = 0; i < drops.length; i++) {
        const text = letters.charAt(Math.floor(Math.random() * letters.length));
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
